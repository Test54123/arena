<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arena</title>
  <style>
    body{
      font-family: monospace;
      background:#dfe9d6;
      padding:14px;
      margin:0;
    }
    h2{ margin: 6px 0 12px; }
    .wrap{ max-width: 900px; margin: 0 auto; }
    .card{
      background:#fffdf1;
      border:2px solid #6a7b5f;
      border-radius:12px;
      padding:12px;
      margin-bottom:14px;
    }
    label{ display:block; margin-top:8px; }
    input,select,button{
      width:100%;
      padding:10px;
      margin-top:6px;
      border-radius:10px;
      border:1px solid #6a7b5f;
      font-size:16px;
      box-sizing:border-box;
    }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    button{
      cursor:pointer;
      background:#eee;
      font-weight:bold;
    }
    button:disabled{ opacity:0.4; cursor:not-allowed; }

    /* board */
    .boardWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; }
    .board{
      width: 300px;
      height: 300px;
      border:2px solid #6a7b5f;
      border-radius:12px;
      background:#f3f1df;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      overflow:hidden;
    }
    .cell{
      border:1px solid rgba(106,123,95,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      user-select:none;
    }
    .corner{
      background: rgba(106,123,95,0.10);
    }
    .unit{
      width: 70%;
      height: 70%;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#fff;
      box-shadow: 0 2px 0 rgba(0,0,0,0.15);
    }
    .unitA{ background:#2b6cff; }
    .unitB{ background:#ff3b3b; }

    /* dpad */
    .dpad{
      display:grid;
      grid-template-columns: 60px 60px 60px;
      grid-template-rows: 60px 60px 60px;
      gap:8px;
      justify-content:center;
      margin-top:10px;
    }
    .dpad button{ height:60px; width:60px; }
    .dpad .empty{ visibility:hidden; }

    #log{
      background:black;
      color:#00ff00;
      padding:10px;
      border-radius:10px;
      min-height:160px;
      white-space:pre-wrap;
      font-size:14px;
      overflow:auto;
    }
    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      padding:6px 10px;
      border:1px solid #6a7b5f;
      border-radius:999px;
      background:#f3f1df;
      display:inline-block;
    }
    .small{ font-size: 13px; opacity: 0.9; }
  </style>
</head>
<body>
<div class="wrap">

  <h2>üè∞ Arena</h2>

  <div class="card">
    <h3>Room</h3>

    <label>Room Code</label>
    <input id="room" value="ARENA"/>

    <label>Password</label>
    <input id="pass" value="rose"/>

    <div class="row" style="margin-top:10px;">
      <button id="btnCreate" onclick="createRoom()">Host (Create)</button>
      <button id="btnSpectate" onclick="joinSpectator()">Spectate</button>
    </div>

    <hr/>

    <h3>Join as Player</h3>

    <label>Your name</label>
    <input id="myName" value="Player"/>

    <label>Seat</label>
    <select id="seat">
      <option value="A">Player A</option>
      <option value="B">Player B</option>
    </select>

    <button onclick="joinPlayer()">Join Player Seat</button>

    <div class="pillRow" style="margin-top:10px;">
      <div class="pill">Status: <span id="status">not connected</span></div>
      <div class="pill">Role: <span id="role">-</span></div>
    </div>

    <div class="small" style="margin-top:8px;">
      ‚úÖ Handy-Steuerung: D-Pad (unten). PC: Pfeiltasten.
    </div>
  </div>

  <div class="card">
    <h3>Game</h3>
    <div id="gameStatus">Not started.</div>

    <div class="boardWrap" style="margin-top:10px;">
      <div>
        <div class="board" id="board"></div>

        <div id="dpadWrap" style="display:none;">
          <div class="dpad">
            <button class="empty">.</button>
            <button onclick="move('up')">‚¨ÜÔ∏è</button>
            <button class="empty">.</button>

            <button onclick="move('left')">‚¨ÖÔ∏è</button>
            <button class="empty">.</button>
            <button onclick="move('right')">‚û°Ô∏è</button>

            <button class="empty">.</button>
            <button onclick="move('down')">‚¨áÔ∏è</button>
            <button class="empty">.</button>
          </div>
        </div>
      </div>

      <div style="flex:1; min-width:260px;">
        <h4>Host Controls</h4>
        <div class="row">
          <input id="nameA" placeholder="Player A name (optional)"/>
          <input id="nameB" placeholder="Player B name (optional)"/>
        </div>

        <div class="row">
          <input id="aHp" placeholder="A HP (default 30)" inputmode="numeric"/>
          <input id="bHp" placeholder="B HP (default 30)" inputmode="numeric"/>
        </div>
        <div class="row">
          <input id="aAtk" placeholder="A ATK (default 5)" inputmode="numeric"/>
          <input id="bAtk" placeholder="B ATK (default 5)" inputmode="numeric"/>
        </div>
        <div class="row">
          <input id="aDef" placeholder="A DEF (default 2)" inputmode="numeric"/>
          <input id="bDef" placeholder="B DEF (default 2)" inputmode="numeric"/>
        </div>
        <div class="row">
          <input id="aHeal" placeholder="A HEAL (default 6)" inputmode="numeric"/>
          <input id="bHeal" placeholder="B HEAL (default 6)" inputmode="numeric"/>
        </div>

        <button id="btnStart" onclick="hostStart()" disabled>Start / Reset Game (Host)</button>

        <hr/>

        <h4>Actions (Players only)</h4>
        <div class="row">
          <button id="btnAttack" onclick="action('attack')" disabled>‚öîÔ∏è Attack</button>
          <button id="btnDefend" onclick="action('defend')" disabled>üõ°Ô∏è Defend</button>
          <button id="btnHeal" onclick="action('heal')" disabled>‚ú® Heal</button>
        </div>

        <div class="small" style="margin-top:8px;">
          Heal & Defend sind pro Spieler auf <b>6√ó</b> begrenzt.
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Battle Log</h3>
    <div id="log">Not connected.</div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  let myRoom = null;
  let myRole = "-"; // host | A | B | spectator | -
  let lastState = null;

  function $(id){ return document.getElementById(id); }

  function setStatus(t){ $("status").textContent = t; }
  function setRole(t){ myRole = t; $("role").textContent = t; }

  function log(msg){
    const box = $("log");
    box.textContent += "\\n" + msg;
    box.scrollTop = box.scrollHeight;
  }

  socket.on("connect", () => {
    $("log").textContent = "";
    setStatus("connected");
    log("‚úÖ Connected to server!");
  });

  socket.on("disconnect", () => {
    setStatus("disconnected");
    log("‚ùå Disconnected.");
  });

  socket.on("errorMsg", (m) => {
    alert(m);
    log("‚ùå " + m);
  });

  socket.on("role", ({ role, room }) => {
    myRoom = room;
    setRole(role);
    updateUI();
  });

  socket.on("log", (line) => log(line));

  socket.on("state", (st) => {
    lastState = st;
    renderState(st);
  });

  function createRoom(){
    const room = $("room").value.trim().toUpperCase();
    const pass = $("pass").value.trim();
    socket.emit("createRoom", { room, pass });
  }

  function joinPlayer(){
    const room = $("room").value.trim().toUpperCase();
    const pass = $("pass").value.trim();
    const role = $("seat").value;
    const name = $("myName").value.trim() || "Player";
    socket.emit("joinRoom", { room, pass, role, name });
  }

  function joinSpectator(){
    const room = $("room").value.trim().toUpperCase();
    const pass = $("pass").value.trim();
    socket.emit("joinRoom", { room, pass, role: "spectator", name: "Spectator" });
  }

  function hostStart(){
    const room = $("room").value.trim().toUpperCase();
    const pass = $("pass").value.trim();

    const settings = {
      aHp: $("aHp").value, bHp: $("bHp").value,
      aAtk: $("aAtk").value, bAtk: $("bAtk").value,
      aDef: $("aDef").value, bDef: $("bDef").value,
      aHeal: $("aHeal").value, bHeal: $("bHeal").value,
    };
    const names = {
      A: $("nameA").value.trim(),
      B: $("nameB").value.trim(),
    };

    socket.emit("hostStart", { room, pass, settings, names });
  }

  function move(dir){
    if (!myRoom) return;
    if (myRole !== "A" && myRole !== "B") return;
    socket.emit("move", { room: myRoom, side: myRole, dir });
  }

  function action(type){
    if (!myRoom) return;
    if (myRole !== "A" && myRole !== "B") return;
    socket.emit("action", { room: myRoom, side: myRole, type });
  }

  // PC controls (arrow keys)
  window.addEventListener("keydown", (e) => {
    if (myRole !== "A" && myRole !== "B") return;
    if (e.key === "ArrowUp") move("up");
    if (e.key === "ArrowDown") move("down");
    if (e.key === "ArrowLeft") move("left");
    if (e.key === "ArrowRight") move("right");
  });

  function updateUI(){
    // host button
    $("btnStart").disabled = (myRole !== "host");

    // actions enabled only for players
    const isPlayer = (myRole === "A" || myRole === "B");
    $("btnAttack").disabled = !isPlayer;
    $("btnDefend").disabled = !isPlayer;
    $("btnHeal").disabled = !isPlayer;

    // show dpad only for players (mobile)
    $("dpadWrap").style.display = isPlayer ? "block" : "none";
  }

  function renderState(st){
    updateUI();

    // status text
    let status = st.started ? "‚úÖ Running (4:00 total, tick every 1:00)" : "Not started.";
    if (st.result){
      if (st.result.winner === "Draw") {
        status = `üèÅ Ended: Draw (A ${st.result.aHp} HP / B ${st.result.bHp} HP)`;
      } else {
        status = `üèÅ Ended: Winner ${st.result.winner} (A ${st.result.aHp} HP / B ${st.result.bHp} HP)`;
      }
    }
    $("gameStatus").textContent = status;

    // Render board (3x3)
    const board = $("board");
    board.innerHTML = "";

    const corners = new Set([
      "0,0",
      "0,"+(st.grid.h-1),
      (st.grid.w-1)+",0",
      (st.grid.w-1)+","+(st.grid.h-1)
    ]);

    for (let y=0; y<st.grid.h; y++){
      for (let x=0; x<st.grid.w; x++){
        const cell = document.createElement("div");
        cell.className = "cell" + (corners.has(x+","+y) ? " corner" : "");

        // place unit
        if (st.units.A.x === x && st.units.A.y === y){
          const u = document.createElement("div");
          u.className = "unit unitA";
          u.textContent = "A";
          cell.appendChild(u);
        }
        if (st.units.B.x === x && st.units.B.y === y){
          const u = document.createElement("div");
          u.className = "unit unitB";
          u.textContent = "B";
          cell.appendChild(u);
        }

        board.appendChild(cell);
      }
    }

    // Action limit info (optional: show in log-ish way)
    if (myRole === "A" || myRole === "B"){
      const me = st.units[myRole];
      $("btnHeal").textContent = `‚ú® Heal (${me.healLeft}/6)`;
      $("btnDefend").textContent = `üõ°Ô∏è Defend (${me.defendLeft}/6)`;
      $("btnAttack").textContent = "‚öîÔ∏è Attack";
    } else {
      $("btnHeal").textContent = "‚ú® Heal";
      $("btnDefend").textContent = "üõ°Ô∏è Defend";
      $("btnAttack").textContent = "‚öîÔ∏è Attack";
    }
  }
</script>
</body>
</html>
