<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arena</title>

  <style>
    body{
      font-family: monospace;
      background:#dfe9d6;
      padding:14px;
      margin:0;
    }
    h2{ margin: 6px 0 12px; }
    .wrap{ max-width: 980px; margin: 0 auto; }
    .card{
      background:#fffdf1;
      border:2px solid #6a7b5f;
      border-radius:12px;
      padding:12px;
      margin-bottom:14px;
    }
    label{ display:block; margin-top:8px; }
    input,select,button{
      width:100%;
      padding:10px;
      margin-top:6px;
      border-radius:10px;
      border:1px solid #6a7b5f;
      font-size:16px;
      box-sizing:border-box;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 140px; }
    button{
      cursor:pointer;
      background:#eee;
      font-weight:bold;
    }
    button:disabled{ opacity:0.4; cursor:not-allowed; }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      padding:6px 10px;
      border:1px solid #6a7b5f;
      border-radius:999px;
      background:#f3f1df;
      display:inline-block;
    }
    .small{ font-size: 13px; opacity: 0.9; margin-top:8px; }

    /* board */
    .boardWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; }
    .board{
      width: 240px;
      height: 240px;
      border:2px solid #6a7b5f;
      border-radius:12px;
      background:#f3f1df;
      display:grid;
      overflow:hidden;
      touch-action: manipulation;
    }
    .cell{
      border:1px solid rgba(106,123,95,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      user-select:none;
      min-height: 0;
      min-width: 0;
    }
    .corner{
      background: rgba(106,123,95,0.12);
    }

    /* tiny "gameboy-ish" units */
    .unit{
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      line-height: 1;
      background: transparent;
      box-shadow:none;
      transform: translateY(-1px);
    }
    .unitA::after{ content:"ü™ñ"; }
    .unitB::after{ content:"üéñÔ∏è"; }

    /* dpad */
    .dpad{
      display:grid;
      grid-template-columns: 64px 64px 64px;
      grid-template-rows: 64px 64px 64px;
      gap:8px;
      justify-content:center;
      margin-top:10px;
    }
    .dpad button{ height:64px; width:64px; }
    .dpad .empty{ visibility:hidden; }

    #log{
      background:black;
      color:#00ff00;
      padding:10px;
      border-radius:10px;
      min-height:180px;
      white-space:pre-wrap;
      font-size:14px;
      overflow:auto;
    }

    .statsBox{
      border:1px dashed rgba(106,123,95,0.7);
      border-radius:10px;
      padding:10px;
      background: rgba(255,255,255,0.35);
      margin-top:10px;
    }
    .statLine{ margin:4px 0; }

    .hintBox{
      border:1px solid rgba(106,123,95,0.35);
      border-radius:10px;
      padding:10px;
      background: rgba(243,241,223,0.55);
      margin-top:10px;
    }
    .monoSmall{ font-size: 12px; opacity: 0.9; }
    .ok{ color:#0a6; font-weight:bold; }
  </style>
</head>

<body>
<div class="wrap">
  <h2 id="title">üè∞ Arena</h2>

  <div class="card">
    <h3 id="roomTitle">Room</h3>

    <label id="roomCodeLbl">Room Code</label>
    <input id="room" value="ARENA"/>

    <label id="passLbl">Password</label>
    <input id="pass" value="rose"/>

    <div class="row" style="margin-top:10px;">
      <button id="btnHost" onclick="connectHost()">Host (Create)</button>
      <button id="btnSpec" onclick="connectSpectate()">Spectate</button>
    </div>

    <hr/>

    <h3 id="joinTitle">Join as Player</h3>

    <label id="nameLbl">Your name</label>
    <input id="myName" value="Player"/>

    <label id="seatLbl">Seat</label>
    <select id="seat">
      <option value="A">Player A</option>
      <option value="B">Player B</option>
    </select>

    <div class="hintBox">
      <b id="optATitle">Option A: Enter Kraft (like screenshot)</b>
      <div class="row">
        <input id="kSquad" placeholder="Squad power (e.g. 36.846.418)" inputmode="numeric"/>
        <input id="kHero" placeholder="Hero power (e.g. 17.030.383)" inputmode="numeric"/>
      </div>
      <div class="row">
        <input id="kBuild" placeholder="Building power" inputmode="numeric"/>
        <input id="kTech" placeholder="Tech power" inputmode="numeric"/>
      </div>
      <div class="row">
        <input id="kGov" placeholder="Governor gear power" inputmode="numeric"/>
        <input id="kPet" placeholder="Pet power" inputmode="numeric"/>
      </div>

      <div class="row">
        <button id="btnCalc" onclick="calcFromKraft()">Calculate ‚Üí fills HP/ATK/DEF</button>
      </div>

      <div class="monoSmall" id="optAHelp">
        Live update: typing Kraft auto-updates HP/ATK/DEF. <span class="ok">‚úÖ</span><br/>
        Fixed conversion: HP from Hero (/1,000,000), ATK from Squad (/2,000,000), DEF from (Build+Tech+Gov+Pet) (/3,000,000). (with limits)
      </div>

      <div class="monoSmall" style="margin-top:6px;">
        <span id="previewLbl">Preview</span>:
        <b>HP</b> <span id="pvHp">-</span> |
        <b>ATK</b> <span id="pvAtk">-</span> |
        <b>DEF</b> <span id="pvDef">-</span> |
        <b id="totalLbl">Total Kraft</b> <span id="pvTotal">-</span>
      </div>
    </div>

    <div class="hintBox">
      <b id="optBTitle">Option B: Enter direct values</b>
      <div class="row">
        <input id="hpMax" placeholder="HP Max (default 50)" inputmode="numeric"/>
        <input id="atk" placeholder="ATK (default 10)" inputmode="numeric"/>
        <input id="def" placeholder="DEF (default 5)" inputmode="numeric"/>
      </div>
      <div class="small" id="optBHelp">If Kraft fields are filled, those will be preferred.</div>
    </div>

    <button id="btnJoinSeat" onclick="joinSeat()">Join Player Seat</button>

    <div class="pillRow">
      <div class="pill"><span id="statusLbl">Status</span>: <span id="status">not connected</span></div>
      <div class="pill"><span id="roleLbl">Role</span>: <span id="role">-</span></div>
      <div class="pill"><span id="gameLbl">Game</span>: <span id="gameLine">-</span></div>
    </div>

    <div class="small" id="controlsHint">
      ‚úÖ Mobile: D-Pad below. Desktop: Arrow keys. <br/>
      ‚ö†Ô∏è Attack works only if you stand next to the enemy (1 tile distance).
    </div>
  </div>

  <div class="card">
    <h3 id="gameTitle">Game</h3>

    <div class="boardWrap">
      <div>
        <div class="board" id="board"></div>

        <div id="dpadWrap" style="display:none;">
          <div class="dpad">
            <button class="empty">.</button>
            <button onclick="move('up')">‚¨ÜÔ∏è</button>
            <button class="empty">.</button>

            <button onclick="move('left')">‚¨ÖÔ∏è</button>
            <button class="empty">.</button>
            <button onclick="move('right')">‚û°Ô∏è</button>

            <button class="empty">.</button>
            <button onclick="move('down')">‚¨áÔ∏è</button>
            <button class="empty">.</button>
          </div>
        </div>
      </div>

      <div style="flex:1; min-width:260px;">
        <h4 id="hostTitle">Host Controls</h4>
        <div class="row">
          <button id="btnStartReset" onclick="hostStartReset()" disabled>Start Game (Host)</button>
        </div>
        <div class="small" id="hostHelp">Game time: 4 minutes. Every minute an event happens (bonus/malus).</div>

        <hr/>

        <h4 id="actionsTitle">Actions (Players only)</h4>
        <div class="row">
          <button id="btnAttack" onclick="action('attack')" disabled>‚öîÔ∏è Attack</button>
          <button id="btnDefend" onclick="action('defend')" disabled>üõ°Ô∏è Defend (0/6)</button>
          <button id="btnHeal" onclick="action('heal')" disabled>‚ú® Heal (0/6)</button>
        </div>

        <div class="statsBox" id="statsBox" style="display:none;">
          <div class="statLine"><b id="meLbl">You</b>: <span id="meName">-</span></div>
          <div class="statLine">HP: <span id="meHp">-</span> / <span id="meHpMax">-</span></div>
          <div class="statLine">ATK: <span id="meAtk">-</span> | DEF: <span id="meDef">-</span></div>
          <div class="statLine"><span id="posLbl">Position</span>: (<span id="meX">-</span>, <span id="meY">-</span>)</div>
          <div class="statLine"><b id="kraftLbl">Kraft total</b>: <span id="meKTotal">-</span></div>
        </div>

        <div class="statsBox" id="oppBox" style="display:none;">
          <div class="statLine"><b id="oppLbl">Opponent</b>: <span id="opName">-</span></div>
          <div class="statLine">HP: <span id="opHp">-</span> / <span id="opHpMax">-</span></div>
          <div class="statLine">ATK: <span id="opAtk">-</span> | DEF: <span id="opDef">-</span></div>
          <div class="statLine"><span id="posLbl2">Position</span>: (<span id="opX">-</span>, <span id="opY">-</span>)</div>
          <div class="statLine"><b id="kraftLbl2">Kraft total</b>: <span id="opKTotal">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 id="logTitle">Battle Log</h3>
    <div id="log">Not connected.</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // ---- language (auto de/en) ----
  const LANG = (navigator.language || "en").toLowerCase().startsWith("de") ? "de" : "en";
  const T = {
    de: {
      room: "Room",
      roomCode: "Room Code",
      password: "Password",
      host: "Host (Create)",
      spectate: "Spectate",
      joinAsPlayer: "Als Spieler beitreten",
      yourName: "Dein Name",
      seat: "Platz",
      optA: "Option A: Kraft eingeben (wie im Screenshot)",
      optAHelp: "Live-Update: beim Tippen werden HP/ATK/DEF automatisch aktualisiert. ‚úÖ\nUmrechnung: HP aus Heldenkraft (/1.000.000), ATK aus Schwadron (/2.000.000), DEF aus (Geb√§ude+Tech+Gov+Pet) (/3.000.000). (mit Limits)",
      preview: "Vorschau",
      totalKraft: "Total Kraft",
      calc: "Aus Kraft berechnen ‚Üí f√ºllt HP/ATK/DEF",
      optB: "Option B: Direktwerte eingeben",
      optBHelp: "Wenn Kraft-Felder ausgef√ºllt sind, werden diese bevorzugt genutzt.",
      joinSeat: "Join Player Seat",
      status: "Status",
      role: "Role",
      game: "Game",
      hint: "‚úÖ Handy: D-Pad unten. PC: Pfeiltasten.\n‚ö†Ô∏è Attack geht nur, wenn du direkt neben dem Gegner stehst (1 Feld Abstand).",
      gameTitle: "Game",
      hostControls: "Host Controls",
      hostHelp: "Spielzeit: 4 Minuten. Jede Minute kommt ein Event (Bonus/Malus).",
      startHost: "Start Game (Host)",
      resetHost: "Reset Game (Host)",
      actions: "Actions (Players only)",
      you: "Du",
      opponent: "Gegner",
      position: "Position",
      battleLog: "Battle Log",
      connected: "connected",
      disconnected: "disconnected",
      logConnected: "‚úÖ Verbunden mit dem Server!",
      kraftToStats: (hp, atk, def) => `üßÆ Kraft‚ÜíStats: HP ${hp} | ATK ${atk} | DEF ${def}`,
      kraftTotal: (tot) => `üìä Kraft total: ${tot}`,
      noKraft: "‚ö†Ô∏è Keine Kraft eingetragen."
    },
    en: {
      room: "Room",
      roomCode: "Room Code",
      password: "Password",
      host: "Host (Create)",
      spectate: "Spectate",
      joinAsPlayer: "Join as Player",
      yourName: "Your name",
      seat: "Seat",
      optA: "Option A: Enter Kraft (like screenshot)",
      optAHelp: "Live update: typing Kraft auto-updates HP/ATK/DEF. ‚úÖ\nFixed conversion: HP from Hero (/1,000,000), ATK from Squad (/2,000,000), DEF from (Build+Tech+Gov+Pet) (/3,000,000). (with limits)",
      preview: "Preview",
      totalKraft: "Total Kraft",
      calc: "Calculate ‚Üí fills HP/ATK/DEF",
      optB: "Option B: Enter direct values",
      optBHelp: "If Kraft fields are filled, those will be preferred.",
      joinSeat: "Join Player Seat",
      status: "Status",
      role: "Role",
      game: "Game",
      hint: "‚úÖ Mobile: D-Pad below. Desktop: Arrow keys.\n‚ö†Ô∏è Attack works only if you stand next to the enemy (1 tile distance).",
      gameTitle: "Game",
      hostControls: "Host Controls",
      hostHelp: "Game time: 4 minutes. Every minute an event happens (bonus/malus).",
      startHost: "Start Game (Host)",
      resetHost: "Reset Game (Host)",
      actions: "Actions (Players only)",
      you: "You",
      opponent: "Opponent",
      position: "Position",
      battleLog: "Battle Log",
      connected: "connected",
      disconnected: "disconnected",
      logConnected: "‚úÖ Connected to server!",
      kraftToStats: (hp, atk, def) => `üßÆ Kraft‚ÜíStats: HP ${hp} | ATK ${atk} | DEF ${def}`,
      kraftTotal: (tot) => `üìä Kraft total: ${tot}`,
      noKraft: "‚ö†Ô∏è No Kraft entered."
    }
  }[LANG];

  function applyTranslations(){
    document.documentElement.lang = (LANG === "de") ? "de" : "en";
    $("roomTitle").textContent = T.room;
    $("roomCodeLbl").textContent = T.roomCode;
    $("passLbl").textContent = T.password;
    $("btnHost").textContent = T.host;
    $("btnSpec").textContent = T.spectate;
    $("joinTitle").textContent = T.joinAsPlayer;
    $("nameLbl").textContent = T.yourName;
    $("seatLbl").textContent = T.seat;
    $("optATitle").textContent = T.optA;
    $("btnCalc").textContent = T.calc;
    $("optAHelp").textContent = T.optAHelp;
    $("previewLbl").textContent = T.preview;
    $("totalLbl").textContent = T.totalKraft;
    $("optBTitle").textContent = T.optB;
    $("optBHelp").textContent = T.optBHelp;
    $("btnJoinSeat").textContent = T.joinSeat;
    $("statusLbl").textContent = T.status;
    $("roleLbl").textContent = T.role;
    $("gameLbl").textContent = T.game;
    $("controlsHint").textContent = T.hint;
    $("gameTitle").textContent = T.gameTitle;
    $("hostTitle").textContent = T.hostControls;
    $("hostHelp").textContent = T.hostHelp;
    $("actionsTitle").textContent = T.actions;
    $("meLbl").textContent = T.you;
    $("oppLbl").textContent = T.opponent;
    $("posLbl").textContent = T.position;
    $("posLbl2").textContent = T.position;
    $("kraftLbl").textContent = T.totalKraft;
    $("kraftLbl2").textContent = T.totalKraft;
    $("logTitle").textContent = T.battleLog;

    // placeholders (optional)
    if (LANG === "de"){
      $("kSquad").placeholder = "Schwadron Kraft (z.B. 36.846.418)";
      $("kHero").placeholder = "Heldenkraft (z.B. 17.030.383)";
      $("kBuild").placeholder = "Geb√§udekraft";
      $("kTech").placeholder = "Technologiekraft";
      $("kGov").placeholder = "Gouverneurausr√ºstung-Kraft";
      $("kPet").placeholder = "Begleittierkraft";
    }
  }

  // ---- state ----
  let currentRoom = null;
  let currentRole = "-"; // host | player | spectator
  let currentSeat = null; // A | B | null
  let isHost = false;      // IMPORTANT: remember if this socket is host
  let lastState = null;

  function $(id){ return document.getElementById(id); }

  function setStatus(t){ $("status").textContent = t; }
  function setRoleText(){
    if (isHost && currentSeat) {
      $("role").textContent = "host + player " + currentSeat;
      return;
    }
    if (isHost) {
      $("role").textContent = "host";
      return;
    }
    if (currentRole === "player") $("role").textContent = "player " + currentSeat;
    else $("role").textContent = currentRole || "-";
  }

  function roomVal(){ return $("room").value.trim().toUpperCase(); }
  function passVal(){ return $("pass").value.trim(); }

  function setLog(lines){
    const box = $("log");
    box.textContent = (lines && lines.length) ? lines.join("\n") : "";
    box.scrollTop = box.scrollHeight;
  }

  // ---------- Kraft -> Stats (client side) ----------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function parseDEInt(v){
    if(!v) return 0;
    const s = String(v).replace(/\./g,'').replace(/\s/g,'').trim();
    const x = parseInt(s, 10);
    return Number.isFinite(x) ? x : 0;
  }

  function kraftObj(){
    return {
      squad: $("kSquad").value,
      build: $("kBuild").value,
      tech:  $("kTech").value,
      gov:   $("kGov").value,
      hero:  $("kHero").value,
      pet:   $("kPet").value,
    };
  }

  function kraftTotal(k){
    return parseDEInt(k.squad) + parseDEInt(k.build) + parseDEInt(k.tech) + parseDEInt(k.gov) + parseDEInt(k.hero) + parseDEInt(k.pet);
  }

  function kraftToStats(k){
    const squad = parseDEInt(k.squad);
    const build = parseDEInt(k.build);
    const tech  = parseDEInt(k.tech);
    const gov   = parseDEInt(k.gov);
    const hero  = parseDEInt(k.hero);
    const pet   = parseDEInt(k.pet);

    const hpMax = clamp(50 + Math.round(hero / 1_000_000), 10, 200);
    const atk   = clamp(10 + Math.round(squad / 2_000_000), 1, 50);
    const defPool = build + tech + gov + pet;
    const def   = clamp(5 + Math.round(defPool / 3_000_000), 0, 50);

    return { hpMax, atk, def };
  }

  function anyKraftFilled(){
    return Object.values(kraftObj()).some(v => String(v||"").trim() !== "");
  }

  function updateKraftPreviewAndStats(){
    const k = kraftObj();
    const has = anyKraftFilled();
    if (!has){
      $("pvHp").textContent = "-";
      $("pvAtk").textContent = "-";
      $("pvDef").textContent = "-";
      $("pvTotal").textContent = "-";
      return;
    }
    const s = kraftToStats(k);
    $("pvHp").textContent = s.hpMax;
    $("pvAtk").textContent = s.atk;
    $("pvDef").textContent = s.def;
    $("pvTotal").textContent = kraftTotal(k).toLocaleString(LANG === "de" ? "de-DE" : "en-US");

    // live-fill direct fields
    $("hpMax").value = String(s.hpMax);
    $("atk").value = String(s.atk);
    $("def").value = String(s.def);
  }

  function calcFromKraft(){
    updateKraftPreviewAndStats();
    const lines = ($("log").textContent || "").split("\n").filter(Boolean);
    if (anyKraftFilled()){
      lines.push(T.kraftToStats($("hpMax").value, $("atk").value, $("def").value));
      lines.push(T.kraftTotal($("pvTotal").textContent));
    } else {
      lines.push(T.noKraft);
    }
    setLog(lines);
  }

  // live listeners
  window.addEventListener("load", () => {
    applyTranslations();
    ["kSquad","kBuild","kTech","kGov","kHero","kPet"].forEach(id=>{
      const el = $(id);
      el.addEventListener("input", updateKraftPreviewAndStats);
      el.addEventListener("change", updateKraftPreviewAndStats);
    });
    updateKraftPreviewAndStats();
  });

  // ---------- sockets ----------
  socket.on("connect", () => {
    setStatus(T.connected);
    setLog([T.logConnected]);
    currentRoom = null;
    currentRole = "-";
    currentSeat = null;
    isHost = false;
    setRoleText();
    updateUI();
    updateKraftPreviewAndStats();
  });

  socket.on("disconnect", () => {
    setStatus(T.disconnected);
  });

  socket.on("errorMsg", (m) => {
    alert(m);
    const lines = ($("log").textContent || "").split("\n").filter(Boolean);
    lines.push("‚ùå " + m);
    setLog(lines);
  });

  // IMPORTANT:
  // If the server tells us we are host, we keep isHost=true.
  // If we join a seat afterwards, we still remain host.
  socket.on("role", ({ role, seat }) => {
    if (role === "host") {
      isHost = true;
      currentRole = "host";
      if (seat === "A" || seat === "B") currentSeat = seat;
    } else if (role === "player") {
      currentRole = "player";
      currentSeat = seat || null;
      // do NOT set isHost=false here; host can also join a seat
    } else {
      currentRole = role;
      currentSeat = null;
    }

    currentRoom = roomVal();
    setRoleText();
    updateUI();
    socket.emit("requestState", { room: currentRoom });
  });

  socket.on("state", (st) => {
    lastState = st;
    render(st);
  });

  function connectHost(){
    socket.emit("hostRoom", { room: roomVal(), pass: passVal() });
  }

  function connectSpectate(){
    socket.emit("spectateRoom", { room: roomVal(), pass: passVal() });
  }

  function joinSeat(){
    const room = roomVal();
    const pass = passVal();
    const seat = $("seat").value;
    const name = ($("myName").value || "").trim();

    let stats;
    const k = kraftObj();

    if (anyKraftFilled()){
      const s = kraftToStats(k);
      stats = {
        hpMax: String(s.hpMax),
        atk: String(s.atk),
        def: String(s.def),
        kraft: k,
      };
      $("hpMax").value = String(s.hpMax);
      $("atk").value = String(s.atk);
      $("def").value = String(s.def);
    } else {
      stats = {
        hpMax: ($("hpMax").value || "").trim(),
        atk:   ($("atk").value || "").trim(),
        def:   ($("def").value || "").trim(),
        kraft: { squad:"",build:"",tech:"",gov:"",hero:"",pet:"" },
      };
    }

    socket.emit("joinSeat", { room, pass, seat, name, stats });
  }

  function hostStartReset(){
    const action = (lastState && lastState.started) ? "reset" : "start";
    socket.emit("hostStartReset", { room: roomVal(), pass: passVal(), action });
  }

  function move(dir){
    if (!currentRoom) return;
    if (!currentSeat) return;
    socket.emit("move", { room: currentRoom, pass: passVal(), dir });
  }

  function action(type){
    if (!currentRoom) return;
    if (!currentSeat) return;
    socket.emit("action", { room: currentRoom, pass: passVal(), type });
  }

  window.addEventListener("keydown", (e) => {
    if (!currentSeat) return;
    if (e.key === "ArrowUp") move("up");
    if (e.key === "ArrowDown") move("down");
    if (e.key === "ArrowLeft") move("left");
    if (e.key === "ArrowRight") move("right");
  });

  function updateUI(){
    // Host button should work if you are host (even if you also joined a seat)
    $("btnStartReset").disabled = !isHost;

    const isPlayer = !!currentSeat; // player actions enabled if seat exists
    $("btnAttack").disabled = !isPlayer;
    $("btnDefend").disabled = !isPlayer;
    $("btnHeal").disabled = !isPlayer;
    $("dpadWrap").style.display = isPlayer ? "block" : "none";
    $("statsBox").style.display = isPlayer ? "block" : "none";
    $("oppBox").style.display = isPlayer ? "block" : "none";
  }

  function render(st){
    updateUI();

    if (!st.started) {
      $("gameLine").textContent = "not started";
    } else {
      const sec = Math.ceil((st.timeLeftMs || 0) / 1000);
      const mm = String(Math.floor(sec/60)).padStart(2,"0");
      const ss = String(sec%60).padStart(2,"0");
      $("gameLine").textContent = `running (${mm}:${ss} left)`;
    }

    if (isHost) {
      $("btnStartReset").textContent = st.started ? T.resetHost : T.startHost;
    } else {
      $("btnStartReset").textContent = T.startHost;
    }

    setLog(st.log || []);

    const w = st.grid?.w || 4;
    const h = st.grid?.h || 4;
    const board = $("board");
    board.style.gridTemplateColumns = `repeat(${w}, 1fr)`;
    board.style.gridTemplateRows = `repeat(${h}, 1fr)`;
    board.innerHTML = "";

    const corners = new Set([`0,0`, `${w-1},0`, `0,${h-1}`, `${w-1},${h-1}`]);

    const A = st.players?.A;
    const B = st.players?.B;

    for (let y=0; y<h; y++){
      for (let x=0; x<w; x++){
        const cell = document.createElement("div");
        cell.className = "cell" + (corners.has(`${x},${y}`) ? " corner" : "");

        if (A && A.pos && A.pos.x === x && A.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitA";
          cell.appendChild(u);
        }
        if (B && B.pos && B.pos.x === x && B.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitB";
          cell.appendChild(u);
        }

        board.appendChild(cell);
      }
    }

    if (currentSeat && st.players && st.players[currentSeat]){
      const me = st.players[currentSeat];
      $("btnDefend").textContent = `üõ°Ô∏è Defend (${me.usedDefend || 0}/6)`;
      $("btnHeal").textContent = `‚ú® Heal (${me.usedHeal || 0}/6)`;
      $("btnAttack").textContent = "‚öîÔ∏è Attack";

      $("meName").textContent = me.name ?? "-";
      $("meHp").textContent = me.hp ?? "-";
      $("meHpMax").textContent = me.hpMax ?? "-";
      $("meAtk").textContent = me.atk ?? "-";
      $("meDef").textContent = me.def ?? "-";
      $("meX").textContent = me.pos?.x ?? "-";
      $("meY").textContent = me.pos?.y ?? "-";
      $("meKTotal").textContent = (me.kraft?.total ?? 0).toLocaleString(LANG === "de" ? "de-DE" : "en-US");

      const oppSeat = (currentSeat === "A") ? "B" : "A";
      const op = st.players[oppSeat];
      $("opName").textContent = op?.name ?? "-";
      $("opHp").textContent = op?.hp ?? "-";
      $("opHpMax").textContent = op?.hpMax ?? "-";
      $("opAtk").textContent = op?.atk ?? "-";
      $("opDef").textContent = op?.def ?? "-";
      $("opX").textContent = op?.pos?.x ?? "-";
      $("opY").textContent = op?.pos?.y ?? "-";
      $("opKTotal").textContent = (op?.kraft?.total ?? 0).toLocaleString(LANG === "de" ? "de-DE" : "en-US");
    } else {
      $("btnDefend").textContent = "üõ°Ô∏è Defend (0/6)";
      $("btnHeal").textContent = "‚ú® Heal (0/6)";
      $("btnAttack").textContent = "‚öîÔ∏è Attack";
    }
  }
</script>
</body>
</html>
