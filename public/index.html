<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arena</title>
  <style>
    body{font-family:monospace;background:#dfe9d6;padding:14px}
    h2{margin:0 0 12px 0}
    .card{background:#fffdf1;border:2px solid #6a7b5f;border-radius:12px;padding:12px;margin-bottom:14px}
    input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #6a7b5f;font-size:16px;box-sizing:border-box}
    button{cursor:pointer;background:#eee;font-weight:bold}
    button:disabled{opacity:.4;cursor:not-allowed}
    .row{display:flex;gap:10px}
    .row > * {flex:1}
    #log{background:black;color:#00ff00;padding:10px;border-radius:10px;min-height:160px;white-space:pre-wrap;font-size:14px}
    .pill{display:inline-block;border:1px solid #6a7b5f;border-radius:999px;padding:6px 10px;margin-top:8px;background:#f3f1df}
    .barWrap{border:1px solid #6a7b5f;border-radius:10px;overflow:hidden;background:#eee;height:18px}
    .bar{height:18px;background:#6a7b5f;width:0%}
    .small{font-size:13px;opacity:.85}
    .sep{margin:10px 0;border-top:1px dashed #6a7b5f}
  </style>
</head>
<body>

<h2>üè∞ Arena</h2>

<div class="card">
  <h3>Room</h3>
  Room Code:
  <input id="room" value="ARENA"/>
  Password:
  <input id="pass" value="rose"/>

  <div class="row">
    <button id="hostBtn" onclick="hostRoom()">Host (Create)</button>
    <button id="specBtn" onclick="spectateRoom()">Spectate</button>
  </div>

  <div class="sep"></div>

  <h3>Join as Player</h3>
  Your name:
  <input id="pname" value="Player"/>

  Seat:
  <select id="seat">
    <option value="A">Player A</option>
    <option value="B">Player B</option>
  </select>

  <div class="row">
    <div>
      HP (max):
      <input id="hp" type="number" value="100" min="10" max="9999"/>
    </div>
    <div>
      ATK:
      <input id="atk" type="number" value="20" min="1" max="999"/>
    </div>
  </div>

  <div class="row">
    <div>
      DEF:
      <input id="def" type="number" value="8" min="0" max="999"/>
    </div>
    <div>
      HEAL:
      <input id="heal" type="number" value="15" min="0" max="999"/>
    </div>
  </div>

  <button onclick="joinSeat()">Join Player Seat</button>

  <div class="row">
    <div class="pill">Status: <span id="status">disconnected</span></div>
    <div class="pill">Role: <span id="role">-</span></div>
  </div>
</div>

<div class="card">
  <h3>Game</h3>

  <div class="small">Player A</div>
  <div><b id="aName">-</b> <span class="small" id="aStats"></span></div>
  <div class="barWrap"><div class="bar" id="aBar"></div></div>
  <div class="small" id="aHpTxt">HP: -</div>

  <div style="height:10px"></div>

  <div class="small">Player B</div>
  <div><b id="bName">-</b> <span class="small" id="bStats"></span></div>
  <div class="barWrap"><div class="bar" id="bBar"></div></div>
  <div class="small" id="bHpTxt">HP: -</div>

  <div class="sep"></div>

  <h3>Host Controls</h3>
  <div class="row">
    <input id="hostAName" placeholder="Player A name (optional)"/>
    <input id="hostBName" placeholder="Player B name (optional)"/>
  </div>
  <button id="startBtn" onclick="startGame()" disabled>Start / Reset Game (Host)</button>

  <div class="sep"></div>

  <h3>Actions (Players only)</h3>
  <div class="row">
    <button id="atkBtn" onclick="doAction('attack')" disabled>‚öîÔ∏è Attack</button>
    <button id="defBtn" onclick="doAction('defend')" disabled>üõ° Defend</button>
    <button id="healBtn" onclick="doAction('heal')" disabled>‚ú® Heal</button>
  </div>

  <div class="pill">Turn: <span id="turn">-</span></div>
  <div class="pill">Winner: <span id="winner">-</span></div>
</div>

<div class="card">
  <h3>Battle Log</h3>
  <div id="log">Not connected.</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  let myRole = "-";     // host | player | spectator
  let mySeat = null;    // "A" | "B" | null
  let currentRoom = null;

  function roomVal(){ return document.getElementById("room").value.trim().toUpperCase(); }
  function passVal(){ return document.getElementById("pass").value.trim(); }

  function log(msg){
    const box = document.getElementById("log");
    if (box.textContent === "Not connected.") box.textContent = "";
    box.textContent += (box.textContent ? "\n" : "") + msg;
    box.scrollTop = box.scrollHeight;
  }

  function setRole(role, seat, room){
    myRole = role || "-";
    mySeat = seat || null;
    currentRoom = room || null;
    document.getElementById("role").textContent = myRole + (mySeat ? " ("+mySeat+")" : "");
    document.getElementById("startBtn").disabled = (myRole !== "host");
    updateActionButtons(null);
  }

  function updateActionButtons(state){
    const canPlayer = (myRole === "player");
    const started = !!state?.started;
    const winner = !!state?.winner;
    const turnOk = (state?.turn && mySeat && state.turn === mySeat);

    const enable = canPlayer && started && !winner && turnOk;
    document.getElementById("atkBtn").disabled = !enable;
    document.getElementById("defBtn").disabled = !enable;
    document.getElementById("healBtn").disabled = !enable;
  }

  function renderState(state){
    const A = state.players.A;
    const B = state.players.B;

    document.getElementById("turn").textContent = state.started ? (state.turn || "-") : "-";
    document.getElementById("winner").textContent = state.winner ? state.winner : "-";

    // A
    document.getElementById("aName").textContent = A ? A.name : "-";
    document.getElementById("aStats").textContent = A ? `(ATK ${A.atk} / DEF ${A.def} / HEAL ${A.heal} / SHIELD ${A.shield})` : "";
    document.getElementById("aHpTxt").textContent = A ? `HP: ${A.hp}/${A.maxHp}` : "HP: -";
    document.getElementById("aBar").style.width = A ? (Math.max(0, Math.min(100, (A.hp/A.maxHp)*100)) + "%") : "0%";

    // B
    document.getElementById("bName").textContent = B ? B.name : "-";
    document.getElementById("bStats").textContent = B ? `(ATK ${B.atk} / DEF ${B.def} / HEAL ${B.heal} / SHIELD ${B.shield})` : "";
    document.getElementById("bHpTxt").textContent = B ? `HP: ${B.hp}/${B.maxHp}` : "HP: -";
    document.getElementById("bBar").style.width = B ? (Math.max(0, Math.min(100, (B.hp/B.maxHp)*100)) + "%") : "0%";

    // Turn hint
    if (state.winner && (A || B)) {
      const winName = state.winner === "A" ? (A?.name || "A") : (B?.name || "B");
      log("üèÜ Winner: " + winName);
    }

    updateActionButtons(state);
  }

  socket.on("connect", ()=>{
    document.getElementById("status").textContent = "connected";
    log("‚úÖ Connected to server!");
  });

  socket.on("disconnect", ()=>{
    document.getElementById("status").textContent = "disconnected";
    log("‚ùå Disconnected.");
  });

  socket.on("log", (msg)=> log(msg));
  socket.on("errorMsg", (msg)=> log("‚ö†Ô∏è " + msg));
  socket.on("role", ({role, seat, room}) => setRole(role, seat, room));
  socket.on("state", (state)=> renderState(state));

  function hostRoom(){
    socket.emit("hostRoom", { room: roomVal(), pass: passVal() });
    log("üéÆ Hosting room: " + roomVal());
  }

  function spectateRoom(){
    socket.emit("spectateRoom", { room: roomVal(), pass: passVal() });
    log("üëÄ Spectating room: " + roomVal());
  }

  function joinSeat(){
    const seat = document.getElementById("seat").value;
    const name = document.getElementById("pname").value.trim();
    const hp = Number(document.getElementById("hp").value);
    const atk = Number(document.getElementById("atk").value);
    const def = Number(document.getElementById("def").value);
    const heal = Number(document.getElementById("heal").value);

    socket.emit("joinSeat", {
      room: roomVal(),
      pass: passVal(),
      seat,
      name,
      hp, atk, def, heal
    });
    log(`ü™ë Joining seat ${seat}...`);
  }

  function startGame(){
    socket.emit("startGame", {
      room: roomVal(),
      pass: passVal(),
      aName: document.getElementById("hostAName").value.trim(),
      bName: document.getElementById("hostBName").value.trim(),
    });
    log("üîÑ Start/Reset requested...");
  }

  function doAction(type){
    socket.emit("action", { room: roomVal(), pass: passVal(), type });
  }
</script>
</body>
</html>
