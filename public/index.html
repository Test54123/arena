<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arena</title>

  <style>
    body{
      font-family: monospace;
      background:#dfe9d6;
      padding:14px;
      margin:0;
    }
    h2{ margin: 6px 0 12px; }
    .wrap{ max-width: 980px; margin: 0 auto; }
    .card{
      background:#fffdf1;
      border:2px solid #6a7b5f;
      border-radius:12px;
      padding:12px;
      margin-bottom:14px;
    }
    label{ display:block; margin-top:8px; }
    input,select,button{
      width:100%;
      padding:10px;
      margin-top:6px;
      border-radius:10px;
      border:1px solid #6a7b5f;
      font-size:16px;
      box-sizing:border-box;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 140px; }
    button{
      cursor:pointer;
      background:#eee;
      font-weight:bold;
    }
    button:disabled{ opacity:0.4; cursor:not-allowed; }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      padding:6px 10px;
      border:1px solid #6a7b5f;
      border-radius:999px;
      background:#f3f1df;
      display:inline-block;
    }
    .small{ font-size: 13px; opacity: 0.9; margin-top:8px; }

    /* board */
    .boardWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; }
    .board{
      width: 320px;
      height: 320px;
      border:2px solid #6a7b5f;
      border-radius:12px;
      background:#f3f1df;
      display:grid;
      overflow:hidden;
      touch-action: manipulation;
    }
    .cell{
      border:1px solid rgba(106,123,95,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      user-select:none;
      min-height: 0;
      min-width: 0;
    }
    .corner{
      background: rgba(106,123,95,0.12);
    }
    .unit{
      width: 70%;
      height: 70%;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#fff;
      box-shadow: 0 2px 0 rgba(0,0,0,0.15);
    }
    .unitA{ background:#2b6cff; }
    .unitB{ background:#ff3b3b; }

    /* dpad */
    .dpad{
      display:grid;
      grid-template-columns: 64px 64px 64px;
      grid-template-rows: 64px 64px 64px;
      gap:8px;
      justify-content:center;
      margin-top:10px;
    }
    .dpad button{ height:64px; width:64px; }
    .dpad .empty{ visibility:hidden; }

    #log{
      background:black;
      color:#00ff00;
      padding:10px;
      border-radius:10px;
      min-height:180px;
      white-space:pre-wrap;
      font-size:14px;
      overflow:auto;
    }

    .statsBox{
      border:1px dashed rgba(106,123,95,0.7);
      border-radius:10px;
      padding:10px;
      background: rgba(255,255,255,0.35);
      margin-top:10px;
    }
    .statLine{ margin:4px 0; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>üè∞ Arena</h2>

  <div class="card">
    <h3>Room</h3>

    <label>Room Code</label>
    <input id="room" value="ARENA"/>

    <label>Password</label>
    <input id="pass" value="rose"/>

    <div class="row" style="margin-top:10px;">
      <button id="btnHost" onclick="connectHost()">Host (Create)</button>
      <button id="btnSpec" onclick="connectSpectate()">Spectate</button>
    </div>

    <hr/>

    <h3>Join as Player</h3>

    <label>Your name</label>
    <input id="myName" value="Player"/>

    <label>Seat</label>
    <select id="seat">
      <option value="A">Player A</option>
      <option value="B">Player B</option>
    </select>

    <div class="row">
      <input id="hpMax" placeholder="HP Max (default 50)" inputmode="numeric"/>
      <input id="atk" placeholder="ATK (default 10)" inputmode="numeric"/>
      <input id="def" placeholder="DEF (default 5)" inputmode="numeric"/>
    </div>

    <button id="btnJoinSeat" onclick="joinSeat()">Join Player Seat</button>

    <div class="pillRow">
      <div class="pill">Status: <span id="status">not connected</span></div>
      <div class="pill">Role: <span id="role">-</span></div>
      <div class="pill">Game: <span id="gameLine">-</span></div>
    </div>

    <div class="small">
      ‚úÖ Handy: D-Pad unten. PC: Pfeiltasten. <br/>
      ‚ö†Ô∏è Attack geht nur, wenn du direkt neben dem Gegner stehst (1 Feld Abstand).
    </div>
  </div>

  <div class="card">
    <h3>Game</h3>

    <div class="boardWrap">
      <div>
        <div class="board" id="board"></div>

        <div id="dpadWrap" style="display:none;">
          <div class="dpad">
            <button class="empty">.</button>
            <button onclick="move('up')">‚¨ÜÔ∏è</button>
            <button class="empty">.</button>

            <button onclick="move('left')">‚¨ÖÔ∏è</button>
            <button class="empty">.</button>
            <button onclick="move('right')">‚û°Ô∏è</button>

            <button class="empty">.</button>
            <button onclick="move('down')">‚¨áÔ∏è</button>
            <button class="empty">.</button>
          </div>
        </div>
      </div>

      <div style="flex:1; min-width:260px;">
        <h4>Host Controls</h4>
        <div class="row">
          <button id="btnStartReset" onclick="hostStartReset()" disabled>Start Game (Host)</button>
        </div>
        <div class="small">Spielzeit: 4 Minuten. Jede Minute kommt ein Event (Bonus/Malus).</div>

        <hr/>

        <h4>Actions (Players only)</h4>
        <div class="row">
          <button id="btnAttack" onclick="action('attack')" disabled>‚öîÔ∏è Attack</button>
          <button id="btnDefend" onclick="action('defend')" disabled>üõ°Ô∏è Defend (0/6)</button>
          <button id="btnHeal" onclick="action('heal')" disabled>‚ú® Heal (0/6)</button>
        </div>

        <div class="statsBox" id="statsBox" style="display:none;">
          <div class="statLine"><b>Du:</b> <span id="meName">-</span></div>
          <div class="statLine">HP: <span id="meHp">-</span> / <span id="meHpMax">-</span></div>
          <div class="statLine">ATK: <span id="meAtk">-</span> | DEF: <span id="meDef">-</span></div>
          <div class="statLine">Position: (<span id="meX">-</span>, <span id="meY">-</span>)</div>
        </div>

        <div class="statsBox" id="oppBox" style="display:none;">
          <div class="statLine"><b>Gegner:</b> <span id="opName">-</span></div>
          <div class="statLine">HP: <span id="opHp">-</span> / <span id="opHpMax">-</span></div>
          <div class="statLine">ATK: <span id="opAtk">-</span> | DEF: <span id="opDef">-</span></div>
          <div class="statLine">Position: (<span id="opX">-</span>, <span id="opY">-</span>)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Battle Log</h3>
    <div id="log">Not connected.</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  let currentRoom = null;
  let currentRole = "-"; // host | player | spectator
  let currentSeat = null; // A | B | null
  let lastState = null;

  function $(id){ return document.getElementById(id); }

  function setStatus(t){ $("status").textContent = t; }
  function setRoleText(){
    if (currentRole === "player") $("role").textContent = "player " + currentSeat;
    else $("role").textContent = currentRole || "-";
  }

  function roomVal(){ return $("room").value.trim().toUpperCase(); }
  function passVal(){ return $("pass").value.trim(); }

  function setLog(lines){
    const box = $("log");
    box.textContent = (lines && lines.length) ? lines.join("\n") : "";
    box.scrollTop = box.scrollHeight;
  }

  socket.on("connect", () => {
    setStatus("connected");
    setLog(["‚úÖ Connected to server!"]);
    currentRoom = null;
    currentRole = "-";
    currentSeat = null;
    setRoleText();
    updateUI();
  });

  socket.on("disconnect", () => {
    setStatus("disconnected");
    // log bleibt stehen
  });

  socket.on("errorMsg", (m) => {
    alert(m);
    // wir h√§ngen es unten ans log an
    const lines = ($("log").textContent || "").split("\n").filter(Boolean);
    lines.push("‚ùå " + m);
    setLog(lines);
  });

  socket.on("role", ({ role, seat }) => {
    currentRole = role;
    currentSeat = seat || null;
    currentRoom = roomVal();
    setRoleText();
    updateUI();
    // state anfordern
    socket.emit("requestState", { room: currentRoom });
  });

  socket.on("state", (st) => {
    lastState = st;
    render(st);
  });

  function connectHost(){
    const room = roomVal();
    const pass = passVal();
    socket.emit("hostRoom", { room, pass });
  }

  function connectSpectate(){
    const room = roomVal();
    const pass = passVal();
    socket.emit("spectateRoom", { room, pass });
  }

  function joinSeat(){
    const room = roomVal();
    const pass = passVal();
    const seat = $("seat").value;
    const name = ($("myName").value || "").trim();

    const stats = {
      hpMax: ($("hpMax").value || "").trim(),
      atk: ($("atk").value || "").trim(),
      def: ($("def").value || "").trim(),
    };

    socket.emit("joinSeat", { room, pass, seat, name, stats });
  }

  function hostStartReset(){
    const room = roomVal();
    const pass = passVal();
    const action = (lastState && lastState.started) ? "reset" : "start";
    socket.emit("hostStartReset", { room, pass, action });
  }

  function move(dir){
    if (!currentRoom) return;
    if (currentRole !== "player") return;
    socket.emit("move", { room: currentRoom, pass: passVal(), dir });
  }

  function action(type){
    if (!currentRoom) return;
    if (currentRole !== "player") return;
    socket.emit("action", { room: currentRoom, pass: passVal(), type });
  }

  // PC: Pfeiltasten
  window.addEventListener("keydown", (e) => {
    if (currentRole !== "player") return;
    if (e.key === "ArrowUp") move("up");
    if (e.key === "ArrowDown") move("down");
    if (e.key === "ArrowLeft") move("left");
    if (e.key === "ArrowRight") move("right");
  });

  function updateUI(){
    $("btnStartReset").disabled = (currentRole !== "host");
    const isPlayer = (currentRole === "player");
    $("btnAttack").disabled = !isPlayer;
    $("btnDefend").disabled = !isPlayer;
    $("btnHeal").disabled = !isPlayer;
    $("dpadWrap").style.display = isPlayer ? "block" : "none";
    $("statsBox").style.display = isPlayer ? "block" : "none";
    $("oppBox").style.display = isPlayer ? "block" : "none";
  }

  function render(st){
    updateUI();

    // Game line
    if (!st.started) {
      $("gameLine").textContent = "not started";
    } else {
      const sec = Math.ceil((st.timeLeftMs || 0) / 1000);
      const mm = String(Math.floor(sec/60)).padStart(2,"0");
      const ss = String(sec%60).padStart(2,"0");
      $("gameLine").textContent = `running (${mm}:${ss} left)`;
    }

    // Host button label
    if (currentRole === "host") {
      $("btnStartReset").textContent = st.started ? "Reset Game (Host)" : "Start Game (Host)";
    } else {
      $("btnStartReset").textContent = "Start Game (Host)";
    }

    // Log
    setLog(st.log || []);

    // Render Board (uses server grid)
    const w = st.grid?.w || 4;
    const h = st.grid?.h || 4;
    const board = $("board");
    board.style.gridTemplateColumns = `repeat(${w}, 1fr)`;
    board.style.gridTemplateRows = `repeat(${h}, 1fr)`;
    board.innerHTML = "";

    const corners = new Set([
      `0,0`,
      `${w-1},0`,
      `0,${h-1}`,
      `${w-1},${h-1}`,
    ]);

    const A = st.players?.A;
    const B = st.players?.B;

    for (let y=0; y<h; y++){
      for (let x=0; x<w; x++){
        const cell = document.createElement("div");
        cell.className = "cell" + (corners.has(`${x},${y}`) ? " corner" : "");

        if (A && A.pos && A.pos.x === x && A.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitA";
          u.textContent = "A";
          cell.appendChild(u);
        }
        if (B && B.pos && B.pos.x === x && B.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitB";
          u.textContent = "B";
          cell.appendChild(u);
        }

        board.appendChild(cell);
      }
    }

    // Player action counters
    if (currentRole === "player" && currentSeat && st.players && st.players[currentSeat]){
      const me = st.players[currentSeat];
      $("btnDefend").textContent = `üõ°Ô∏è Defend (${me.usedDefend || 0}/6)`;
      $("btnHeal").textContent = `‚ú® Heal (${me.usedHeal || 0}/6)`;
      $("btnAttack").textContent = "‚öîÔ∏è Attack";

      $("meName").textContent = me.name ?? "-";
      $("meHp").textContent = me.hp ?? "-";
      $("meHpMax").textContent = me.hpMax ?? "-";
      $("meAtk").textContent = me.atk ?? "-";
      $("meDef").textContent = me.def ?? "-";
      $("meX").textContent = me.pos?.x ?? "-";
      $("meY").textContent = me.pos?.y ?? "-";

      const oppSeat = (currentSeat === "A") ? "B" : "A";
      const op = st.players[oppSeat];
      $("opName").textContent = op?.name ?? "-";
      $("opHp").textContent = op?.hp ?? "-";
      $("opHpMax").textContent = op?.hpMax ?? "-";
      $("opAtk").textContent = op?.atk ?? "-";
      $("opDef").textContent = op?.def ?? "-";
      $("opX").textContent = op?.pos?.x ?? "-";
      $("opY").textContent = op?.pos?.y ?? "-";
    } else {
      $("btnDefend").textContent = "üõ°Ô∏è Defend (0/6)";
      $("btnHeal").textContent = "‚ú® Heal (0/6)";
      $("btnAttack").textContent = "‚öîÔ∏è Attack";
    }
  }
</script>
</body>
</html>
