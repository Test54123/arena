<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Arena</title>

  <style>
    :root{
      --bg:#dfe9d6;
      --card:#fffdf1;
      --line:#6a7b5f;
      --soft:#f3f1df;
      --ink:#1a1a1a;
    }

    body{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:var(--bg);
      padding:14px;
      margin:0;
      color:var(--ink);
    }
    h2{ margin: 6px 0 12px; }
    .wrap{ max-width: 980px; margin: 0 auto; }
    .card{
      background:var(--card);
      border:2px solid var(--line);
      border-radius:12px;
      padding:12px;
      margin-bottom:14px;
    }
    label{ display:block; margin-top:8px; }
    input,select,button{
      width:100%;
      padding:10px;
      margin-top:6px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:16px;
      box-sizing:border-box;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 140px; }
    button{
      cursor:pointer;
      background:#eee;
      font-weight:bold;
    }
    button:disabled{ opacity:0.4; cursor:not-allowed; }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--soft);
      display:inline-block;
    }
    .small{ font-size: 13px; opacity: 0.9; margin-top:8px; }
    .monoSmall{ font-size: 12px; opacity: 0.9; }
    .ok{ color:#0a6; font-weight:bold; }

    /* board (fixed + clean on mobile) */
    .boardWrap{ display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; }

    .board{
      width:min(320px, 92vw);
      aspect-ratio: 1 / 1;
      border:2px solid var(--line);
      border-radius:14px;
      background:var(--soft);
      display:grid;
      overflow:hidden;
      touch-action: manipulation;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.35);
    }
    .cell{
      border:1px solid rgba(106,123,95,0.35);
      position:relative;
      user-select:none;
      min-height: 0;
      min-width: 0;
    }
    .corner{ background: rgba(106,123,95,0.12); }

    /* Retro ‚ÄúGameboy-ish‚Äù units (small, pixel-ish) */
    .unit{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      image-rendering: pixelated;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,0.22));
      opacity: 0.98;
    }
    .unitA{ }
    .unitB{ }

    /* simple pixel soldier as SVG; colored per team */
    .unitA{
      background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'>\
<rect width='16' height='16' fill='none'/>\
<rect x='6' y='2' width='4' height='2' fill='%232b6cff'/>\
<rect x='5' y='4' width='6' height='3' fill='%232b6cff'/>\
<rect x='6' y='7' width='4' height='4' fill='%232b6cff'/>\
<rect x='5' y='11' width='2' height='3' fill='%232b6cff'/>\
<rect x='9' y='11' width='2' height='3' fill='%232b6cff'/>\
<rect x='4' y='7' width='2' height='2' fill='%232b6cff'/>\
<rect x='10' y='7' width='2' height='2' fill='%232b6cff'/>\
<rect x='6' y='1' width='4' height='1' fill='%231a1a1a' opacity='0.35'/>\
</svg>");
      background-size: cover;
    }
    .unitB{
      background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'>\
<rect width='16' height='16' fill='none'/>\
<rect x='6' y='2' width='4' height='2' fill='%23ff3b3b'/>\
<rect x='5' y='4' width='6' height='3' fill='%23ff3b3b'/>\
<rect x='6' y='7' width='4' height='4' fill='%23ff3b3b'/>\
<rect x='5' y='11' width='2' height='3' fill='%23ff3b3b'/>\
<rect x='9' y='11' width='2' height='3' fill='%23ff3b3b'/>\
<rect x='4' y='7' width='2' height='2' fill='%23ff3b3b'/>\
<rect x='10' y='7' width='2' height='2' fill='%23ff3b3b'/>\
<rect x='6' y='1' width='4' height='1' fill='%231a1a1a' opacity='0.35'/>\
</svg>");
      background-size: cover;
    }

    /* dpad */
    .dpad{
      display:grid;
      grid-template-columns: 64px 64px 64px;
      grid-template-rows: 64px 64px 64px;
      gap:8px;
      justify-content:center;
      margin-top:10px;
    }
    .dpad button{ height:64px; width:64px; }
    .dpad .empty{ visibility:hidden; }

    #log{
      background:black;
      color:#00ff00;
      padding:10px;
      border-radius:10px;
      min-height:180px;
      white-space:pre-wrap;
      font-size:14px;
      overflow:auto;
    }

    .statsBox{
      border:1px dashed rgba(106,123,95,0.7);
      border-radius:10px;
      padding:10px;
      background: rgba(255,255,255,0.35);
      margin-top:10px;
    }
    .statLine{ margin:4px 0; }

    .hintBox{
      border:1px solid rgba(106,123,95,0.35);
      border-radius:10px;
      padding:10px;
      background: rgba(243,241,223,0.55);
      margin-top:10px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h2>üè∞ <span id="t_title">Arena</span></h2>

  <div class="card">
    <h3 id="t_room">Room</h3>

    <label id="t_roomCode">Room Code</label>
    <input id="room" value="ARENA"/>

    <label id="t_password">Password</label>
    <input id="pass" value="rose"/>

    <div class="row" style="margin-top:10px;">
      <button id="btnHost" onclick="connectHost()">Host (Create)</button>
      <button id="btnSpec" onclick="connectSpectate()">Spectate</button>
    </div>

    <hr/>

    <h3 id="t_joinAsPlayer">Join as Player</h3>

    <label id="t_yourName">Your name</label>
    <input id="myName" value="Player"/>

    <label id="t_seat">Seat</label>
    <select id="seat">
      <option value="A" id="t_seatA">Player A</option>
      <option value="B" id="t_seatB">Player B</option>
    </select>

    <div class="hintBox">
      <b id="t_optA">Option A: Enter Kraft (like screenshot)</b>
      <div class="row">
        <input id="kSquad" placeholder="Squad kraft (e.g. 36.846.418)" inputmode="numeric"/>
        <input id="kHero" placeholder="Hero kraft (e.g. 17.030.383)" inputmode="numeric"/>
      </div>
      <div class="row">
        <input id="kBuild" placeholder="Building kraft" inputmode="numeric"/>
        <input id="kTech" placeholder="Tech kraft" inputmode="numeric"/>
      </div>
      <div class="row">
        <input id="kGov" placeholder="Governor gear kraft" inputmode="numeric"/>
        <input id="kPet" placeholder="Pet kraft" inputmode="numeric"/>
      </div>

      <div class="row">
        <button id="btnCalc" onclick="calcFromKraft()">Calc from Kraft ‚Üí fills HP/ATK/DEF</button>
      </div>

      <div class="monoSmall" id="t_liveHint">
        Live update is active: as soon as you type Kraft, HP/ATK/DEF auto-update. <span class="ok">‚úÖ</span><br/>
        Fixed formula: HP from Hero (/1,000,000), ATK from Squad (/2,000,000), DEF from (Build+Tech+Gov+Pet) (/3,000,000). (with limits)
      </div>

      <div class="monoSmall" style="margin-top:6px;">
        <span id="t_preview">Preview</span>:
        <b>HP</b> <span id="pvHp">-</span> |
        <b>ATK</b> <span id="pvAtk">-</span> |
        <b>DEF</b> <span id="pvDef">-</span> |
        <b><span id="t_totalKraft">Total Kraft</span></b> <span id="pvTotal">-</span>
      </div>
    </div>

    <div class="hintBox">
      <b id="t_optB">Option B: Enter direct values</b>
      <div class="row">
        <input id="hpMax" placeholder="HP Max (default 50)" inputmode="numeric"/>
        <input id="atk" placeholder="ATK (default 10)" inputmode="numeric"/>
        <input id="def" placeholder="DEF (default 5)" inputmode="numeric"/>
      </div>
      <div class="small" id="t_prefKraft">If Kraft fields are filled, Kraft is preferred.</div>
    </div>

    <button id="btnJoinSeat" onclick="joinSeat()">Join Player Seat</button>

    <div class="pillRow">
      <div class="pill"><span id="t_status">Status</span>: <span id="status">not connected</span></div>
      <div class="pill"><span id="t_role">Role</span>: <span id="role">-</span></div>
      <div class="pill"><span id="t_game">Game</span>: <span id="gameLine">-</span></div>
    </div>

    <div class="small" id="t_controlsHint">
      ‚úÖ Phone: D-Pad below. PC: Arrow keys. <br/>
      ‚ö†Ô∏è Attack only works when you stand directly next to the opponent (distance 1 tile).
    </div>
  </div>

  <div class="card">
    <h3 id="t_gameTitle">Game</h3>

    <div class="boardWrap">
      <div>
        <div class="board" id="board"></div>

        <div id="dpadWrap" style="display:none;">
          <div class="dpad">
            <button class="empty">.</button>
            <button onclick="move('up')">‚¨ÜÔ∏è</button>
            <button class="empty">.</button>

            <button onclick="move('left')">‚¨ÖÔ∏è</button>
            <button class="empty">.</button>
            <button onclick="move('right')">‚û°Ô∏è</button>

            <button class="empty">.</button>
            <button onclick="move('down')">‚¨áÔ∏è</button>
            <button class="empty">.</button>
          </div>
        </div>
      </div>

      <div style="flex:1; min-width:260px;">
        <h4 id="t_hostControls">Host Controls</h4>
        <div class="row">
          <button id="btnStartReset" onclick="hostStartReset()" disabled>Start Game (Host)</button>
        </div>
        <div class="small" id="t_duration">Duration: 4 minutes. Each minute an event (bonus/malus).</div>

        <hr/>

        <h4 id="t_actions">Actions (Players only)</h4>
        <div class="row">
          <button id="btnAttack" onclick="action('attack')" disabled>‚öîÔ∏è Attack</button>
          <button id="btnDefend" onclick="action('defend')" disabled>üõ°Ô∏è Defend (0/6)</button>
          <button id="btnHeal" onclick="action('heal')" disabled>‚ú® Heal (0/6)</button>
        </div>

        <div class="statsBox" id="statsBox" style="display:none;">
          <div class="statLine"><b id="t_you">You</b>: <span id="meName">-</span></div>
          <div class="statLine">HP: <span id="meHp">-</span> / <span id="meHpMax">-</span></div>
          <div class="statLine">ATK: <span id="meAtk">-</span> | DEF: <span id="meDef">-</span></div>
          <div class="statLine"><span id="t_position">Position</span>: (<span id="meX">-</span>, <span id="meY">-</span>)</div>
          <div class="statLine"><b><span id="t_kraftTotal">Kraft total</span>:</b> <span id="meKTotal">-</span></div>
        </div>

        <div class="statsBox" id="oppBox" style="display:none;">
          <div class="statLine"><b id="t_enemy">Enemy</b>: <span id="opName">-</span></div>
          <div class="statLine">HP: <span id="opHp">-</span> / <span id="opHpMax">-</span></div>
          <div class="statLine">ATK: <span id="opAtk">-</span> | DEF: <span id="opDef">-</span></div>
          <div class="statLine"><span id="t_position2">Position</span>: (<span id="opX">-</span>, <span id="opY">-</span>)</div>
          <div class="statLine"><b><span id="t_kraftTotal2">Kraft total</span>:</b> <span id="opKTotal">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 id="t_log">Battle Log</h3>
    <div id="log">Not connected.</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ---------- i18n ----------
  const LANG = (navigator.language || "en").toLowerCase().startsWith("de") ? "de" : "en";
  document.documentElement.lang = LANG;

  const I18N = {
    en: {
      title:"Arena",
      room:"Room",
      roomCode:"Room Code",
      password:"Password",
      joinAsPlayer:"Join as Player",
      yourName:"Your name",
      seat:"Seat",
      seatA:"Player A",
      seatB:"Player B",
      optA:"Option A: Enter Kraft (like screenshot)",
      calc:"Calc from Kraft ‚Üí fills HP/ATK/DEF",
      liveHint:"Live update is active: as soon as you type Kraft, HP/ATK/DEF auto-update. ‚úÖ\nFixed formula: HP from Hero (/1,000,000), ATK from Squad (/2,000,000), DEF from (Build+Tech+Gov+Pet) (/3,000,000). (with limits)",
      preview:"Preview",
      totalKraft:"Total Kraft",
      optB:"Option B: Enter direct values",
      prefKraft:"If Kraft fields are filled, Kraft is preferred.",
      status:"Status",
      role:"Role",
      game:"Game",
      controlsHint:"‚úÖ Phone: D-Pad below. PC: Arrow keys.\n‚ö†Ô∏è Attack only works when you stand directly next to the opponent (distance 1 tile).",
      gameTitle:"Game",
      hostControls:"Host Controls",
      startHost:"Start Game (Host)",
      resetHost:"Reset Game (Host)",
      duration:"Duration: 4 minutes. Each minute an event (bonus/malus).",
      actions:"Actions (Players only)",
      you:"You",
      enemy:"Enemy",
      position:"Position",
      kraftTotal:"Kraft total",
      log:"Battle Log",
      connected:"connected",
      disconnected:"disconnected",
      notStarted:"not started",
      running:(mmss)=>`running (${mmss} left)`
    },
    de: {
      title:"Arena",
      room:"Room",
      roomCode:"Room Code",
      password:"Passwort",
      joinAsPlayer:"Als Spieler beitreten",
      yourName:"Dein Name",
      seat:"Platz",
      seatA:"Spieler A",
      seatB:"Spieler B",
      optA:"Option A: Kraft eingeben (wie im Screenshot)",
      calc:"Aus Kraft berechnen ‚Üí f√ºllt HP/ATK/DEF",
      liveHint:"Live-Update ist aktiv: sobald du Kraft eintippst, werden HP/ATK/DEF automatisch aktualisiert. ‚úÖ\nUmrechnung (fest): HP aus Heldenkraft (/1.000.000), ATK aus Schwadron (/2.000.000), DEF aus (Geb√§ude+Tech+Gov+Pet) (/3.000.000). (mit Limits)",
      preview:"Vorschau",
      totalKraft:"Total Kraft",
      optB:"Option B: Direktwerte eingeben",
      prefKraft:"Wenn Kraft-Felder ausgef√ºllt sind, werden diese bevorzugt genutzt.",
      status:"Status",
      role:"Rolle",
      game:"Spiel",
      controlsHint:"‚úÖ Handy: D-Pad unten. PC: Pfeiltasten.\n‚ö†Ô∏è Attack geht nur, wenn du direkt neben dem Gegner stehst (1 Feld Abstand).",
      gameTitle:"Spiel",
      hostControls:"Host-Steuerung",
      startHost:"Spiel starten (Host)",
      resetHost:"Spiel zur√ºcksetzen (Host)",
      duration:"Spielzeit: 4 Minuten. Jede Minute kommt ein Event (Bonus/Malus).",
      actions:"Aktionen (nur Spieler)",
      you:"Du",
      enemy:"Gegner",
      position:"Position",
      kraftTotal:"Kraft total",
      log:"Battle Log",
      connected:"verbunden",
      disconnected:"getrennt",
      notStarted:"nicht gestartet",
      running:(mmss)=>`l√§uft (${mmss} √ºbrig)`
    }
  };

  function t(key, ...args){
    const dict = I18N[LANG] || I18N.en;
    const v = dict[key];
    if (typeof v === "function") return v(...args);
    return v ?? key;
  }

  function applyI18n(){
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    set("t_title", t("title"));
    set("t_room", t("room"));
    set("t_roomCode", t("roomCode"));
    set("t_password", t("password"));
    set("t_joinAsPlayer", t("joinAsPlayer"));
    set("t_yourName", t("yourName"));
    set("t_seat", t("seat"));
    set("t_seatA", t("seatA"));
    set("t_seatB", t("seatB"));
    set("t_optA", t("optA"));
    set("btnCalc", t("calc"));
    set("t_liveHint", t("liveHint"));
    set("t_preview", t("preview"));
    set("t_totalKraft", t("totalKraft"));
    set("t_optB", t("optB"));
    set("t_prefKraft", t("prefKraft"));
    set("t_status", t("status"));
    set("t_role", t("role"));
    set("t_game", t("game"));
    set("t_controlsHint", t("controlsHint"));
    set("t_gameTitle", t("gameTitle"));
    set("t_hostControls", t("hostControls"));
    set("t_duration", t("duration"));
    set("t_actions", t("actions"));
    set("t_you", t("you"));
    set("t_enemy", t("enemy"));
    set("t_position", t("position"));
    set("t_position2", t("position"));
    set("t_kraftTotal", t("kraftTotal"));
    set("t_kraftTotal2", t("kraftTotal"));
    set("t_log", t("log"));
  }

  applyI18n();

  // ---------- sockets ----------
  const socket = io();

  let currentRoom = null;
  let currentRole = "-"; // host | player | spectator
  let currentSeat = null; // A | B | null
  let lastState = null;

  function $(id){ return document.getElementById(id); }

  function setStatusText(t){ $("status").textContent = t; }
  function setRoleText(){
    if (currentRole === "player") $("role").textContent = "player " + currentSeat;
    else $("role").textContent = currentRole || "-";
  }

  function roomVal(){ return $("room").value.trim().toUpperCase(); }
  function passVal(){ return $("pass").value.trim(); }

  function setLog(lines){
    const box = $("log");
    box.textContent = (lines && lines.length) ? lines.join("\n") : "";
    box.scrollTop = box.scrollHeight;
  }

  // ---------- Kraft -> Stats (client side) ----------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function parseDEInt(v){
    if(!v) return 0;
    const s = String(v).replace(/\./g,'').replace(/\s/g,'').trim();
    const x = parseInt(s, 10);
    return Number.isFinite(x) ? x : 0;
  }

  function kraftObj(){
    return {
      squad: $("kSquad").value,
      build: $("kBuild").value,
      tech:  $("kTech").value,
      gov:   $("kGov").value,
      hero:  $("kHero").value,
      pet:   $("kPet").value,
    };
  }

  function kraftTotal(k){
    return parseDEInt(k.squad) + parseDEInt(k.build) + parseDEInt(k.tech) + parseDEInt(k.gov) + parseDEInt(k.hero) + parseDEInt(k.pet);
  }

  function kraftToStats(k){
    const squad = parseDEInt(k.squad);
    const build = parseDEInt(k.build);
    const tech  = parseDEInt(k.tech);
    const gov   = parseDEInt(k.gov);
    const hero  = parseDEInt(k.hero);
    const pet   = parseDEInt(k.pet);

    const hpMax = clamp(50 + Math.round(hero / 1_000_000), 10, 200);
    const atk   = clamp(10 + Math.round(squad / 2_000_000), 1, 50);
    const defPool = build + tech + gov + pet;
    const def   = clamp(5 + Math.round(defPool / 3_000_000), 0, 50);

    return { hpMax, atk, def };
  }

  function anyKraftFilled(){
    return Object.values(kraftObj()).some(v => String(v||"").trim() !== "");
  }

  function fmtNumber(n){
    const locale = (LANG === "de") ? "de-DE" : "en-US";
    return Number(n || 0).toLocaleString(locale);
  }

  function updateKraftPreviewAndStats(){
    const k = kraftObj();
    const has = anyKraftFilled();
    if (!has){
      $("pvHp").textContent = "-";
      $("pvAtk").textContent = "-";
      $("pvDef").textContent = "-";
      $("pvTotal").textContent = "-";
      return;
    }
    const s = kraftToStats(k);
    $("pvHp").textContent = s.hpMax;
    $("pvAtk").textContent = s.atk;
    $("pvDef").textContent = s.def;
    $("pvTotal").textContent = fmtNumber(kraftTotal(k));

    $("hpMax").value = String(s.hpMax);
    $("atk").value = String(s.atk);
    $("def").value = String(s.def);
  }

  function calcFromKraft(){
    updateKraftPreviewAndStats();
    const lines = ($("log").textContent || "").split("\n").filter(Boolean);
    if (anyKraftFilled()){
      lines.push(`üßÆ Kraft‚ÜíStats: HP ${$("hpMax").value} | ATK ${$("atk").value} | DEF ${$("def").value}`);
      lines.push(`üìä ${t("totalKraft")}: ${$("pvTotal").textContent}`);
    } else {
      lines.push(LANG === "de" ? "‚ö†Ô∏è Keine Kraft eingetragen." : "‚ö†Ô∏è No Kraft entered.");
    }
    setLog(lines);
  }

  window.addEventListener("load", () => {
    ["kSquad","kBuild","kTech","kGov","kHero","kPet"].forEach(id=>{
      const el = $(id);
      el.addEventListener("input", updateKraftPreviewAndStats);
      el.addEventListener("change", updateKraftPreviewAndStats);
    });
    updateKraftPreviewAndStats();
  });

  socket.on("connect", () => {
    setStatusText(t("connected"));
    setLog(["‚úÖ Connected to server!"]);
    currentRoom = null;
    currentRole = "-";
    currentSeat = null;
    setRoleText();
    updateUI();
  });

  socket.on("disconnect", () => {
    setStatusText(t("disconnected"));
  });

  socket.on("errorMsg", (m) => {
    alert(m);
    const lines = ($("log").textContent || "").split("\n").filter(Boolean);
    lines.push("‚ùå " + m);
    setLog(lines);
  });

  socket.on("role", ({ role, seat }) => {
    currentRole = role;
    currentSeat = seat || null;
    currentRoom = roomVal();
    setRoleText();
    updateUI();
    socket.emit("requestState", { room: currentRoom });
  });

  socket.on("state", (st) => {
    lastState = st;
    render(st);
  });

  function connectHost(){
    socket.emit("hostRoom", { room: roomVal(), pass: passVal() });
  }

  function connectSpectate(){
    socket.emit("spectateRoom", { room: roomVal(), pass: passVal() });
  }

  function joinSeat(){
    const room = roomVal();
    const pass = passVal();
    const seat = $("seat").value;
    const name = ($("myName").value || "").trim();

    let stats;
    const k = kraftObj();

    if (anyKraftFilled()){
      const s = kraftToStats(k);
      stats = {
        hpMax: String(s.hpMax),
        atk: String(s.atk),
        def: String(s.def),
        kraft: k,
      };
      $("hpMax").value = String(s.hpMax);
      $("atk").value = String(s.atk);
      $("def").value = String(s.def);
    } else {
      stats = {
        hpMax: ($("hpMax").value || "").trim(),
        atk:   ($("atk").value || "").trim(),
        def:   ($("def").value || "").trim(),
        kraft: { squad:"",build:"",tech:"",gov:"",hero:"",pet:"" },
      };
    }

    socket.emit("joinSeat", { room, pass, seat, name, stats });
  }

  function hostStartReset(){
    const action = (lastState && lastState.started) ? "reset" : "start";
    socket.emit("hostStartReset", { room: roomVal(), pass: passVal(), action });
  }

  function move(dir){
    if (!currentRoom) return;
    if (currentRole !== "player") return;
    socket.emit("move", { room: currentRoom, pass: passVal(), dir });
  }

  function action(type){
    if (!currentRoom) return;
    if (currentRole !== "player") return;
    socket.emit("action", { room: currentRoom, pass: passVal(), type });
  }

  window.addEventListener("keydown", (e) => {
    if (currentRole !== "player") return;
    if (e.key === "ArrowUp") move("up");
    if (e.key === "ArrowDown") move("down");
    if (e.key === "ArrowLeft") move("left");
    if (e.key === "ArrowRight") move("right");
  });

  function updateUI(){
    $("btnStartReset").disabled = (currentRole !== "host");
    const isPlayer = (currentRole === "player");
    $("btnAttack").disabled = !isPlayer;
    $("btnDefend").disabled = !isPlayer;
    $("btnHeal").disabled = !isPlayer;
    $("dpadWrap").style.display = isPlayer ? "block" : "none";
    $("statsBox").style.display = isPlayer ? "block" : "none";
    $("oppBox").style.display = isPlayer ? "block" : "none";
  }

  function render(st){
    updateUI();

    if (!st.started) {
      $("gameLine").textContent = t("notStarted");
    } else {
      const sec = Math.ceil((st.timeLeftMs || 0) / 1000);
      const mm = String(Math.floor(sec/60)).padStart(2,"0");
      const ss = String(sec%60).padStart(2,"0");
      $("gameLine").textContent = t("running", `${mm}:${ss}`);
    }

    if (currentRole === "host") {
      $("btnStartReset").textContent = st.started ? t("resetHost") : t("startHost");
    } else {
      $("btnStartReset").textContent = t("startHost");
    }

    setLog(st.log || []);

    const w = st.grid?.w || 4;
    const h = st.grid?.h || 4;
    const board = $("board");
    board.style.gridTemplateColumns = `repeat(${w}, 1fr)`;
    board.style.gridTemplateRows = `repeat(${h}, 1fr)`;
    board.innerHTML = "";

    const corners = new Set([`0,0`, `${w-1},0`, `0,${h-1}`, `${w-1},${h-1}`]);

    const A = st.players?.A;
    const B = st.players?.B;

    for (let y=0; y<h; y++){
      for (let x=0; x<w; x++){
        const cell = document.createElement("div");
        cell.className = "cell" + (corners.has(`${x},${y}`) ? " corner" : "");

        if (A && A.pos && A.pos.x === x && A.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitA";
          cell.appendChild(u);
        }
        if (B && B.pos && B.pos.x === x && B.pos.y === y){
          const u = document.createElement("div");
          u.className = "unit unitB";
          cell.appendChild(u);
        }

        board.appendChild(cell);
      }
    }

    if (currentRole === "player" && currentSeat && st.players && st.players[currentSeat]){
      const me = st.players[currentSeat];
      $("btnDefend").textContent = `üõ°Ô∏è Defend (${me.usedDefend || 0}/6)`;
      $("btnHeal").textContent = `‚ú® Heal (${me.usedHeal || 0}/6)`;
      $("btnAttack").textContent = "‚öîÔ∏è Attack";

      $("meName").textContent = me.name ?? "-";
      $("meHp").textContent = me.hp ?? "-";
      $("meHpMax").textContent = me.hpMax ?? "-";
      $("meAtk").textContent = me.atk ?? "-";
      $("meDef").textContent = me.def ?? "-";
      $("meX").textContent = me.pos?.x ?? "-";
      $("meY").textContent = me.pos?.y ?? "-";
      $("meKTotal").textContent = fmtNumber(me.kraft?.total ?? 0);

      const oppSeat = (currentSeat === "A") ? "B" : "A";
      const op = st.players[oppSeat];
      $("opName").textContent = op?.name ?? "-";
      $("opHp").textContent = op?.hp ?? "-";
      $("opHpMax").textContent = op?.hpMax ?? "-";
      $("opAtk").textContent = op?.atk ?? "-";
      $("opDef").textContent = op?.def ?? "-";
      $("opX").textContent = op?.pos?.x ?? "-";
      $("opY").textContent = op?.pos?.y ?? "-";
      $("opKTotal").textContent = fmtNumber(op?.kraft?.total ?? 0);
    } else {
      $("btnDefend").textContent = "üõ°Ô∏è Defend (0/6)";
      $("btnHeal").textContent = "‚ú® Heal (0/6)";
      $("btnAttack").textContent = "‚öîÔ∏è Attack";
    }
  }
</script>
</body>
</html>
